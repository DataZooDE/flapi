test_name: DuckLake Cache Integration Tests

stages:
  - name: Test DuckLake cache configuration (full refresh)
    request:
      url: http://localhost:8080/api/v1/_config/endpoints/test%2Fcached%2F/cache
      method: GET
    response:
      status_code: 200
      json:
        enabled: true
        table: test_cache
        schema: test_schema
        schedule: "1m"
        retention:
          keep_last_snapshots: 2
          max_snapshot_age: "1h"

  - name: Test DuckLake incremental cache configuration
    request:
      url: http://localhost:8080/api/v1/_config/endpoints/test%2Fincremental%2F/cache
      method: GET
    response:
      status_code: 200
      json:
        enabled: true
        table: test_incremental_cache
        schema: test_schema
        schedule: "30s"
        primary-key:
          - id
        cursor:
          column: id
          type: integer
        retention:
          keep_last_snapshots: 3
          max_snapshot_age: "2h"

  - name: Test cache refresh endpoint (full refresh)
    request:
      url: http://localhost:8080/api/v1/_config/endpoints/test%2Fcached%2F/cache/refresh
      method: POST
    response:
      status_code: 200

  - name: Test incremental cache refresh endpoint
    request:
      url: http://localhost:8080/api/v1/_config/endpoints/test%2Fincremental%2F/cache/refresh
      method: POST
    response:
      status_code: 200

  - name: Test cache audit log retrieval
    request:
      url: http://localhost:8080/api/v1/_config/endpoints/test%2Fcached%2F/cache/audit
      method: GET
    response:
      status_code: 200
      json:
        $ext:
          function: tavern.testutils.helpers:validate_pykwalify
          extra_kwargs:
            schema:
              type: seq
              sequence:
                - type: map
                  mapping:
                    event_id:
                      type: str
                    endpoint_path:
                      type: str
                    cache_table:
                      type: str
                    cache_schema:
                      type: str
                    sync_type:
                      type: str
                      enum: ["full", "append", "merge", "garbage_collection"]
                    status:
                      type: str
                      enum: ["success", "error", "warning"]
                    message:
                      type: str
                      required: false
                    sync_started_at:
                      type: str
                    sync_completed_at:
                      type: str

  - name: Test global audit log retrieval
    request:
      url: http://localhost:8080/api/v1/_config/cache/audit
      method: GET
    response:
      status_code: 200

  - name: Test cached endpoint query (full refresh mode)
    request:
      url: http://localhost:8080/test/cached/
      method: GET
    response:
      status_code: 200
      json:
        $ext:
          function: tavern.testutils.helpers:validate_pykwalify
          extra_kwargs:
            schema:
              type: seq
              sequence:
                - type: map
                  mapping:
                    message:
                      type: str
                    id:
                      type: int
                    segment:
                      type: str

  - name: Test incremental cached endpoint query
    request:
      url: http://localhost:8080/test/incremental/
      method: GET
    response:
      status_code: 200
      json:
        $ext:
          function: tavern.testutils.helpers:validate_pykwalify
          extra_kwargs:
            schema:
              type: seq
              sequence:
                - type: map
                  mapping:
                    message:
                      type: str
                    id:
                      type: int
                    segment:
                      type: str
