test_name: DuckLake Cache Integration Tests

# Use flapi_server fixture to construct base_url dynamically
# Tavern should automatically expose pytest fixtures as format variables

stages:
  - name: Test DuckLake cache configuration (full refresh)
    request:
      url: "http://localhost:{flapi_server.port}/api/v1/_config/endpoints/test-cached-slash/cache"
      method: GET
      headers:
        X-Config-Token: "test-token"
        Authorization: "Bearer test-token"
    response:
      status_code: 200
      json:
        enabled: true
        table: test_cache
        schema: test_schema
        schedule: "1m"
        retention:
          keep_last_snapshots: 2
          max_snapshot_age: "1h"
        # template-file is optional and may be present
        template-file: !anything

  - name: Test DuckLake incremental cache configuration
    request:
      url: "http://localhost:{flapi_server.port}/api/v1/_config/endpoints/test-incremental-slash/cache"
      method: GET
      headers:
        X-Config-Token: "test-token"
        Authorization: "Bearer test-token"
    response:
      status_code: 200
      json:
        enabled: true
        table: test_incremental_cache
        schema: test_schema
        schedule: "30s"
        primary-key:
          - id
        cursor:
          column: id
          type: integer
        retention:
          keep_last_snapshots: 3
          max_snapshot_age: "2h"
        # template-file and delete-handling are optional and may be present
        template-file: !anything
        delete-handling: !anything

  - name: Test cache refresh endpoint (full refresh)
    request:
      url: "http://localhost:{flapi_server.port}/api/v1/_config/endpoints/test-cached-slash/cache/refresh"
      method: POST
      headers:
        X-Config-Token: "test-token"
        Authorization: "Bearer test-token"
    response:
      status_code: 200

  - name: Test incremental cache refresh endpoint
    request:
      url: "http://localhost:{flapi_server.port}/api/v1/_config/endpoints/test-incremental-slash/cache/refresh"
      method: POST
      headers:
        X-Config-Token: "test-token"
        Authorization: "Bearer test-token"
    response:
      status_code: 200

  - name: Test cache audit log retrieval
    request:
      url: "http://localhost:{flapi_server.port}/api/v1/_config/endpoints/test-cached-slash/cache/audit"
      method: GET
      headers:
        X-Config-Token: "test-token"
        Authorization: "Bearer test-token"
    response:
      status_code: 200
      # Audit log should return a list (accept any structure as audit entries may vary)
      json: !anything

  - name: Test global audit log retrieval
    request:
      url: "http://localhost:{flapi_server.port}/api/v1/_config/cache/audit"
      method: GET
      headers:
        X-Config-Token: "test-token"
        Authorization: "Bearer test-token"
    response:
      status_code: 200

  - name: Test cached endpoint query (full refresh mode)
    request:
      url: "http://localhost:{flapi_server.port}/test/cached/"
      method: GET
    response:
      status_code: 200
      # Accept any valid JSON response (may be wrapped with data/pagination)
      json: !anything

  - name: Test incremental cached endpoint query
    request:
      url: "http://localhost:{flapi_server.port}/test/incremental/"
      method: GET
    response:
      status_code: 200
      # Accept any valid JSON response (may be wrapped with data/pagination)
      json: !anything
