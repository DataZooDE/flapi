---
test_name: Comprehensive DuckLake Cache Integration Tests
marks:
  - integration
  - ducklake
  - cache

stages:
  # Test 1: Full Refresh Mode (no cursor, no primary key)
  - name: Test full refresh cache mode
    request:
      url: "{base_url}/api/v1/_config/endpoints/test-cached-slash/cache"
      method: GET
      headers:
        X-Config-Token: "test-token"
        Authorization: "Bearer test-token"
    response:
      status_code: 200
      strict: false
      json:
        enabled: true
        table: test_cache
        schema: test_schema
        schedule: "1m"

  # Test 2: Incremental Append Mode (cursor only)
  - name: Test incremental append cache mode
    request:
      url: "{base_url}/api/v1/_config/endpoints/test-append-slash/cache"
      method: GET
      headers:
        X-Config-Token: "test-token"
        Authorization: "Bearer test-token"
    response:
      status_code: 200
      strict: false
      json:
        enabled: true
        table: test_append_cache
        schema: test_schema
        schedule: "30s"

  # Test 3: Incremental Merge Mode (cursor + primary key)
  - name: Test incremental merge cache mode
    request:
      url: "{base_url}/api/v1/_config/endpoints/test-merge-slash/cache"
      method: GET
      headers:
        X-Config-Token: "test-token"
        Authorization: "Bearer test-token"
    response:
      status_code: 200
      strict: false
      json:
        enabled: true
        table: test_merge_cache
        schema: test_schema
        schedule: "15s"

  # Test 4: Cache refresh for full mode
  - name: Test full refresh cache refresh
    request:
      url: "{base_url}/api/v1/_config/endpoints/test-cached-slash/cache/refresh"
      method: POST
      headers:
        X-Config-Token: "test-token"
        Authorization: "Bearer test-token"
    response:
      status_code: 200

  # Test 5: Verify audit log is accessible
  - name: Test audit log shows cache operations
    request:
      url: "{base_url}/api/v1/_config/cache/audit"
      method: GET
      headers:
        X-Config-Token: "test-token"
        Authorization: "Bearer test-token"
    response:
      status_code: 200

  # Test 6: Test garbage collection
  - name: Test garbage collection endpoint
    request:
      url: "{base_url}/api/v1/_config/endpoints/test-cached-slash/cache/gc"
      method: POST
      headers:
        X-Config-Token: "test-token"
        Authorization: "Bearer test-token"
    response:
      status_code: 200

  # Test 7: Test cached endpoint queries for all modes
  - name: Test full refresh cached endpoint
    request:
      url: "{base_url}/test/cached/"
      method: GET
    response:
      status_code: 200

  - name: Test append mode cached endpoint
    request:
      url: "{base_url}/test/append/"
      method: GET
    response:
      status_code: 200

  - name: Test merge mode cached endpoint
    request:
      url: "{base_url}/test/merge/"
      method: GET
    response:
      status_code: 200

  # Test 8: Test error handling for invalid cache configurations
  - name: Test invalid cache configuration handling
    request:
      url: "{base_url}/api/v1/_config/endpoints/test-invalid-slash/cache"
      method: GET
      headers:
        X-Config-Token: "test-token"
        Authorization: "Bearer test-token"
    response:
      status_code: 404

  # Test 9: Verify endpoint-specific audit log
  - name: Test endpoint-specific audit log
    request:
      url: "{base_url}/api/v1/_config/endpoints/test-cached-slash/cache/audit"
      method: GET
      headers:
        X-Config-Token: "test-token"
        Authorization: "Bearer test-token"
    response:
      status_code: 200
