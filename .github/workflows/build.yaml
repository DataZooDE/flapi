name: Build flAPI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  linux-amd64:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Linux Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ninja-build linux-libc-dev cmake make gcc-multilib g++-multilib libssl-dev wget zip unixodbc-dev libc6-dev-i386 lib32readline6-dev libssl-dev libcurl4-gnutls-dev libexpat1-dev gettext unzip build-essential checkinstall libffi-dev curl libz-dev openssh-client pkg-config

    - name: Build
      run: |
        make release
        mkdir -p build/release
        cp build/release/flapi build/release/
        chmod +x build/release/flapi

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: flapi-linux-amd64
        path: build/release/flapi
        if-no-files-found: error
        retention-days: 90

  linux-aarch64:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Dependencies
      run: |
        sudo dpkg --add-architecture arm64
        sudo apt-get update
        sudo apt-get install -y \
          ninja-build cmake make \
          crossbuild-essential-arm64 \
          gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
          libssl-dev:arm64 \
          zlib1g-dev:arm64 \
          pkg-config

    - name: Configure vcpkg for cross-compilation
      run: |
        echo "set(VCPKG_TARGET_ARCHITECTURE arm64)" >> $GITHUB_WORKSPACE/vcpkg/triplets/community/arm64-linux.cmake
        echo "set(VCPKG_CRT_LINKAGE dynamic)" >> $GITHUB_WORKSPACE/vcpkg/triplets/community/arm64-linux.cmake
        echo "set(VCPKG_LIBRARY_LINKAGE static)" >> $GITHUB_WORKSPACE/vcpkg/triplets/community/arm64-linux.cmake
        echo "set(VCPKG_CMAKE_SYSTEM_NAME Linux)" >> $GITHUB_WORKSPACE/vcpkg/triplets/community/arm64-linux.cmake
        echo "set(VCPKG_CHAINLOAD_TOOLCHAIN_FILE ${GITHUB_WORKSPACE}/cmake/aarch64-linux-gnu.cmake)" >> $GITHUB_WORKSPACE/vcpkg/triplets/community/arm64-linux.cmake

    - name: Create Toolchain File
      run: |
        mkdir -p cmake
        cat << EOF > cmake/aarch64-linux-gnu.cmake
        set(CMAKE_SYSTEM_NAME Linux)
        set(CMAKE_SYSTEM_PROCESSOR aarch64)
        
        set(CMAKE_C_COMPILER aarch64-linux-gnu-gcc)
        set(CMAKE_CXX_COMPILER aarch64-linux-gnu-g++)
        
        set(CMAKE_FIND_ROOT_PATH /usr/aarch64-linux-gnu)
        set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
        set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
        set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
        set(CMAKE_FIND_ROOT_PATH_MODE_PACKAGE ONLY)
        EOF

    - name: Build
      run: |
        cmake -B build/release \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_TOOLCHAIN_FILE=cmake/aarch64-linux-gnu.cmake \
          -DVCPKG_TARGET_TRIPLET=arm64-linux \
          -DVCPKG_CHAINLOAD_TOOLCHAIN_FILE=${GITHUB_WORKSPACE}/cmake/aarch64-linux-gnu.cmake \
          -G Ninja
        cmake --build build/release
        mkdir -p build/release
        chmod +x build/release/flapi

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: flapi-linux-arm64
        path: build/release/flapi
        if-no-files-found: error
        retention-days: 90

  osx-universal:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Build
      run: |
        make release
        mkdir -p build/release
        cp build/universal/flapi build/release/
        chmod +x build/release/flapi

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: flapi-macos-universal
        path: build/release/flapi
        if-no-files-found: error
        retention-days: 90

  docker:
    needs: [linux-amd64, linux-aarch64]
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Prepare build context
      run: |
        mkdir -p build/release
        cp artifacts/flapi-linux-amd64/flapi build/release/flapi.amd64
        cp artifacts/flapi-linux-arm64/flapi build/release/flapi.arm64
        chmod +x build/release/flapi.*

    - name: Build and push multi-platform Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: Dockerfile
        platforms: linux/amd64,linux/arm64
        push: true
        tags: |
          ghcr.io/${{ github.repository_owner }}/flapi:latest
          ghcr.io/${{ github.repository_owner }}/flapi:${{ github.sha }}
