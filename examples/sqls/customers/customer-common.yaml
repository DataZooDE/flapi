# ====================================================================================
# CONSOLIDATED CUSTOMER CONFIGURATION
# ====================================================================================
# This file contains all shared configuration components for customer endpoints.
# Use section includes to access specific parts: {{include:section_name from common/customer-common.yaml}}

# ====================================================================================
# REQUEST FIELDS - Common request parameters
# ====================================================================================
request:
  - field-name: id
    field-in: query
    description: Customer ID
    required: false
    validators:
      - type: int
        min: 1
        max: 1000000
        preventSqlInjection: true

  - field-name: segment
    field-in: query
    description: Customer market segment (optional)
    required: false
    validators:
      - type: enum
        allowedValues: [AUTOMOBILE, BUILDING, FURNITURE, HOUSEHOLD, MACHINERY]

  - field-name: email
    field-in: query
    description: Customer email address
    required: false
    validators:
      - type: email

  - field-name: registration_date
    field-in: query
    description: Customer registration date
    required: false
    validators:
      - type: date
        min: "2000-01-01"
        max: "2025-12-31"

  - field-name: name
    field-in: query
    description: Customer name
    required: false
    validators:
      - type: string
        regex: "^[A-Za-z ]{2,50}$"
        preventSqlInjection: true

  - field-name: uuid
    field-in: query
    description: Customer UUID
    required: false
    validators:
      - type: uuid

# ====================================================================================
# AUTHENTICATION CONFIGURATIONS
# ====================================================================================

# Default/Basic Authentication
auth:
  enabled: true
  type: basic
  users:
    - username: admin
      password: secret
      roles: [admin, read, write]
    - username: '{{env.CUSTOMER_API_READ_USER}}'
      password: '{{env.CUSTOMER_API_READ_PASSWORD}}'
      roles: [read]
    - username: '{{env.CUSTOMER_API_AI_USER}}'
      password: '{{env.CUSTOMER_API_AI_PASSWORD}}'
      roles: [ai_tools, read]

# Development Authentication (disabled)
auth-dev:
  enabled: false  # Disable auth in development for easier testing

# Production Authentication (JWT)
auth-prod:
  enabled: true
  type: jwt
  jwt-secret: '{{env.CUSTOMER_API_JWT_SECRET}}'
  jwt-issuer: '{{env.CUSTOMER_API_JWT_ISSUER}}'

# Staging Authentication (Basic with different users)
auth-staging:
  enabled: true
  type: basic
  users:
    - username: '{{env.STAGING_API_USER}}'
      password: '{{env.STAGING_API_PASSWORD}}'
      roles: [read, write]

# ====================================================================================
# RATE LIMITING CONFIGURATIONS
# ====================================================================================

# Standard Rate Limiting
rate-limit:
  enabled: true
  max: 100
  interval: 60  # 1 minute window

# High-Traffic Rate Limiting
rate-limit-high:
  enabled: true
  max: 1000
  interval: 60  # 1 minute window

# Development Rate Limiting (more permissive)
rate-limit-dev:
  enabled: true
  max: 1000
  interval: 10  # 10 second window, high limits for testing

# AI Tools Rate Limiting (lower limits)
rate-limit-ai:
  enabled: true
  max: 50
  interval: 60  # AI tools typically need fewer requests

# ====================================================================================
# CONNECTION AND TEMPLATE CONFIGURATIONS
# ====================================================================================

# Standard Connection
connection:
  - customers-parquet

# Template Source
template-source: customers.sql

# Development Connection (might use different data)
connection-dev:
  - customers-dev-parquet

# Production Connection (might use multiple sources)
connection-prod:
  - customers-prod-parquet
  - customers-backup-parquet

# ====================================================================================
# CACHING CONFIGURATIONS (DuckLake-based)
# ====================================================================================

# Standard DuckLake Caching
cache:
  enabled: true
  table: customers_cache
  schema: analytics  # Optional: defaults to 'main'
  schedule: 5m
  primary-key: [id]  # Primary key for incremental merge operations
  cursor:
    column: registration_date  # Cursor column for incremental append
    type: date
  rollback-window: 2d  # Allow rollback within 2 days
  retention:
    keep-last-snapshots: 5
    max-snapshot-age: 14d
  delete-handling: soft  # How to handle deleted records

# High-Performance DuckLake Caching
cache-performance:
  enabled: true
  table: customers_perf_cache
  schema: analytics
  schedule: 1m
  primary-key: [id]
  cursor:
    column: registration_date
    type: date
  retention:
    keep-last-snapshots: 10
    max-snapshot-age: 7d
  delete-handling: hard
  template-file: customers_cache.sql  # Optional: custom cache template

# Development Caching (disabled for testing)
cache-dev:
  enabled: false

# ====================================================================================
# HEARTBEAT CONFIGURATIONS
# ====================================================================================

# Standard Heartbeat
heartbeat:
  enabled: true
  params:
    service: customer-api
    environment: '{{env.ENVIRONMENT}}'

# Disabled Heartbeat
heartbeat-disabled:
  enabled: false

# Enhanced Heartbeat (with more monitoring)
heartbeat-enhanced:
  enabled: true
  params:
    service: customer-api
    environment: '{{env.ENVIRONMENT}}'
    version: '{{env.API_VERSION}}'
    instance_id: '{{env.INSTANCE_ID}}'
